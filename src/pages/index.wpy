<template>
  <view class="container">
    <view class="content hide {{currentTabIndex == '0' ? 'active' : ''}}">
      <map id="map" longitude="{{longitude}}" latitude="{{latitude}}" scale="{{scale}}" bindmarkertap="markertap" markers="{{markers}}" show-location></map>
    </view>
    <view class="content hide {{currentTabIndex == '1' ? 'active' : ''}}">
      <list :resList.sync="resList"></list>
    </view>
    <view class="selectarea">
      <view class="nav-left hide {{currentTabIndex == '1' ? 'active' : ''}}" id="0" bindtap="changeTab">
        <text class="iconfont icon-ditu"></text>
      </view>
      <view class="nav-left hide {{currentTabIndex == '0' ? 'active' : ''}}" id="1" bindtap="changeTab">
        <text class="iconfont icon-dingdan"></text>
      </view>
      <selector></selector>
      <navigator class="nav-right" url="/pages/profile"><text class="iconfont icon-wode"></text></navigator>
    </view>
  </view>
</template>

<script>
  import wepy from 'wepy'
  import _ from 'lodash'
  import List from '../components/reslist'
  import Select from '../components/select'
  var QQMapWX = require('../libs/qqmap-wx-jssdk.js')
  var qqmapsdk
  export default class Index extends wepy.page {
    config = {
      navigationBarTitleText: '杭州美食地图'
    }
    components = {
      selector: Select,
      list: List
    }
    data = {
      currentTabIndex: 0,
      selected: 'hotel',
      markers: [],
      resList: [],
      longitude: '',
      latitude: '',
      scale: ''
    }
    onLoad() {
      this.getRestaurant()
      qqmapsdk = new QQMapWX({
        key: 'GWTBZ-5UNCJ-TJAFJ-KRNNM-YIMEF-4GFBM'
      })
    }
    getRestaurant() {
      var that = this
      wepy.request({
        url:'https://876379022.supergrass.club/weapp/demo',
        method: 'POST',
        data:{
          tag: this.selected
        },
        success: function(res){
          var data = res.data.data
          var marker_new = []
          var list_new = []
          var include_new = []
          data.forEach((val) => {
            var lnglat = val.lnglat.split(',')
            marker_new.push({
              iconPath: "/resources/mark.png",
              id: val.id,
              latitude: lnglat[1],
              longitude: lnglat[0],
              width: 33,
              height: 33,
              title: val.resname,
              callout:{
                content: val.resname,
                display: 'ALWAYS',
                padding: 5,
                borderRadius: 50,
                bgColor: "#ffffff",
                color: "#333333",
                fontSize: 12
              },
              anchor:{x:.5,y:1}
            })
            list_new.push({
              name: val.resname,
              lnglat: val.lnglat
            })
            include_new.push([lnglat[0],lnglat[1]])
          })
          
          that.markers = marker_new
          that.resList = list_new
          that.included = include_new
          that.longitude = '120.149799'
          that.latitude = '30.246539'
          that.scale = 15
          that.$apply()
        }
      })
    }
    changeTab(e){
      var index = e.currentTarget.id
      this.currentTabIndex = index
      this.$apply()
    }
    markertap(e) {
      var index = _.findIndex(this.markers,['id',e.markerId])
      var tapedMarker = this.markers[index]
      wepy.showActionSheet({
        itemList: ['种草', '拔草','去'+tapedMarker.title],
        success: function(res) {
          if(res.tapIndex == 2) {
            wepy.openLocation({
              latitude: tapedMarker.latitude - 0,
              name: tapedMarker.title,
              longitude: tapedMarker.longitude - 0,
              scale: 18
            })
          }
        },
        fail: function(res) {
          console.log(res.errMsg)
        }
      })
    }
    events = {
      'reGet': (p1,$event) => {
        this.selected = p1
        this.$apply()
        this.getRestaurant()
      },
      'locate': (lnglat) => {
        this.currentTabIndex = 0
        var lnglatarr = lnglat.split(',')
        this.longitude = lnglatarr[0] + ''
        this.latitude = lnglatarr[1] + ''
        //this.scale = 18
        this.$apply()
      }
    }
  }  
</script>
<style>
.hide{
  display: none;
}
.active{
  display: block;
}
#map{
  width:100%;
  height: 100%;
}
</style>
